{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Admin Dashboard</h1>
    <a href="{{ url_for('auth.logout') }}" class="btn btn-danger mb-3">Logout</a>

    <!-- Analytics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Packages</h5>
                    <h2>{{ total_packages }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Total Events</h5>
                    <h2>{{ total_events }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">Total Banners</h5>
                    <h2>{{ total_banners }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <h5 class="card-title">Total Testimonials</h5>
                    <h2>{{ total_testimonials }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Package Destinations</h5>
                </div>
                <div class="card-body">
                    <canvas id="destinationsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="queries" class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Query Operations</h2>
            <a href="{{ url_for('admin.query_inbox') }}" class="btn btn-outline-primary btn-sm">Go to inbox</a>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary h-100">
                    <div class="card-body">
                        <p class="text-uppercase small mb-1">Open tickets</p>
                        <h2>{{ total_queries }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger h-100">
                    <div class="card-body">
                        <p class="text-uppercase small mb-1">Overdue SLA</p>
                        <h2>{{ overdue_queries }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning h-100">
                    <div class="card-body">
                        <p class="text-uppercase small mb-1">Due soon (2h)</p>
                        <h2>{{ due_soon_queries }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-secondary h-100">
                    <div class="card-body">
                        <p class="text-uppercase small mb-1">Unassigned</p>
                        <h2>{{ unassigned_queries }}</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Status distribution</div>
                    <div class="card-body">
                        <canvas id="queryStatusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Query types</div>
                    <div class="card-body">
                        <canvas id="queryTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5>Average response time</h5>
                        <p class="display-6">{{ avg_first_response or '—' }} <small class="text-muted">min</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5>Average resolution time</h5>
                        <p class="display-6">{{ avg_resolution_hours or '—' }} <small class="text-muted">hrs</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5>Staff performance</h5>
                        <ul class="list-group list-group-flush">
                            {% for staff in staff_performance %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>{{ staff.name }}</span>
                                    <span class="text-muted">{{ staff.tickets }} tickets · {{ staff.avg_resolution or '—' }}h</span>
                                </li>
                            {% else %}
                                <li class="list-group-item text-muted">No assignments yet.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2>Packages</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_package') }}" class="btn btn-primary">Add New Package</a>
        <a href="{{ url_for('admin.export_packages') }}" class="btn btn-success">Export Packages</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for package in packages %}
            <tr>
                <td>{{ package.id }}</td>
                <td>{{ package.title }}</td>
                <td>{{ package.price }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_package', id=package.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.duplicate_package', id=package.id) }}" class="btn btn-sm btn-info">Duplicate</a>
                    <a href="{{ url_for('admin.delete_package', id=package.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Events</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_event') }}" class="btn btn-primary">Add New Event</a>
        <a href="{{ url_for('admin.export_events') }}" class="btn btn-success">Export Events</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr>
                <td>{{ event.id }}</td>
                <td>{{ event.title }}</td>
                <td>{{ event.date }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_event', id=event.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.delete_event', id=event.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Banners</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_banner') }}" class="btn btn-primary">Add New Banner</a>
        <a href="{{ url_for('admin.export_banners') }}" class="btn btn-success">Export Banners</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Image</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for banner in banners %}
            <tr>
                <td>{{ banner.id }}</td>
                <td>{{ banner.title }}</td>
                <td><img src="{{ banner.image }}" alt="{{ banner.title }}" style="width: 50px; height: 50px;"></td>
                <td>{{ 'Yes' if banner.is_active else 'No' }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_banner', id=banner.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.delete_banner', id=banner.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Testimonials</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_testimonial') }}" class="btn btn-primary">Add New Testimonial</a>
        <a href="{{ url_for('admin.export_testimonials') }}" class="btn btn-success">Export Testimonials</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Message</th>
                <th>Rating</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for testimonial in testimonials %}
            <tr>
                <td>{{ testimonial.id }}</td>
                <td>{{ testimonial.name }}</td>
                <td>{{ testimonial.message[:50] }}{% if testimonial.message|length > 50 %}...{% endif %}</td>
                <td>{{ testimonial.rating }}</td>
                <td>{{ 'Yes' if testimonial.is_active else 'No' }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_testimonial', id=testimonial.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.delete_testimonial', id=testimonial.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Pages</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_page') }}" class="btn btn-primary">Add New Page</a>
        <a href="{{ url_for('admin.export_pages') }}" class="btn btn-success">Export Pages</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Slug</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for page in pages %}
            <tr>
                <td>{{ page.id }}</td>
                <td>{{ page.title }}</td>
                <td>{{ page.slug }}</td>
                <td>{{ 'Yes' if page.is_active else 'No' }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_page', id=page.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.delete_page', id=page.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                    {% if page.slug == 'contact' %}
                    <a href="{{ url_for('main.contact') }}" target="_blank" class="btn btn-sm btn-info">View Page</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>FAQs</h2>
    <div class="mb-3">
        <a href="{{ url_for('admin.new_faq') }}" class="btn btn-primary">Add New FAQ</a>
        <a href="{{ url_for('admin.export_faqs') }}" class="btn btn-success">Export FAQs</a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Question</th>
                <th>Category</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for faq in faqs %}
            <tr>
                <td>{{ faq.id }}</td>
                <td>{{ faq.question[:50] }}{% if faq.question|length > 50 %}...{% endif %}</td>
                <td>{{ faq.category }}</td>
                <td>{{ 'Yes' if faq.is_active else 'No' }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_faq', id=faq.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{{ url_for('admin.delete_faq', id=faq.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Destinations Pie Chart
    const destinationsCtx = document.getElementById('destinationsChart').getContext('2d');
    const destinationsChart = new Chart(destinationsCtx, {
        type: 'pie',
        data: {
            labels: {{ destinations|tojson }},
            datasets: [{
                data: {{ dest_counts|tojson }},
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    const queryStatusCtx = document.getElementById('queryStatusChart');
    if (queryStatusCtx) {
        new Chart(queryStatusCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: {{ status_labels|tojson }},
                datasets: [{
                    data: {{ status_counts|tojson }},
                    backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#6c757d', '#dc3545', '#20c997']
                }]
            }
        });
    }

    const queryTypeCtx = document.getElementById('queryTypeChart');
    if (queryTypeCtx) {
        new Chart(queryTypeCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ query_type_labels|tojson }},
                datasets: [{
                    label: 'Tickets',
                    data: {{ query_type_counts|tojson }},
                    backgroundColor: '#20c997'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
