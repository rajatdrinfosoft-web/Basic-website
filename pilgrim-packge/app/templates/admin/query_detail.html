{% extends 'admin/base.html' %}

{% block title %}Query {{ query.ticket_number or ('Q-' ~ query.id) }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <div>
            <h1 class="mb-1">Ticket {{ query.ticket_number or ('Q-' ~ query.id) }}</h1>
            <p class="text-muted mb-0">Created {{ query.created_at.strftime('%Y-%m-%d %H:%M') }} • Last updated {{ query.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        <a href="{{ url_for('admin.query_inbox') }}" class="btn btn-link">← Back to inbox</a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Ticket summary</h5>
                    <p class="mb-1"><strong>Status:</strong> <span class="badge bg-secondary">{{ query.status }}</span></p>
                    <p class="mb-1"><strong>Priority:</strong>
                        {% if query.priority == 'Urgent' %}
                            <span class="badge bg-danger">{{ query.priority }}</span>
                        {% elif query.priority == 'Escalated' %}
                            <span class="badge bg-danger">{{ query.priority }}</span>
                        {% else %}
                            <span class="badge bg-info text-dark">{{ query.priority }}</span>
                        {% endif %}
                    </p>
                    <p class="mb-1"><strong>Assigned to:</strong> {{ query.assigned_staff.username if query.assigned_staff else 'Unassigned' }}</p>
                    {% if query.sla_deadline %}
                        <p class="mb-1"><strong>SLA deadline:</strong> {{ query.sla_deadline.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p class="mb-1"><strong>SLA remaining:</strong>
                            {% if query.minutes_to_sla() is not none %}
                                {% if query.minutes_to_sla() < 0 %}
                                    <span class="text-danger">{{ query.minutes_to_sla()|abs }} min overdue</span>
                                {% else %}
                                    <span class="text-success">{{ query.minutes_to_sla() }} min</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">n/a</span>
                            {% endif %}
                        </p>
                    {% endif %}
                    {% if query.escalated_at %}
                        <p class="mb-0 text-danger"><strong>Escalated:</strong> {{ query.escalated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Customer profile</h5>
                    <p class="mb-1"><strong>Name:</strong> {{ query.customer_name }}</p>
                    <p class="mb-1"><strong>Email:</strong> <a href="mailto:{{ query.customer_email }}">{{ query.customer_email }}</a></p>
                    <p class="mb-1"><strong>Phone:</strong> {{ query.customer_phone or 'Not provided' }}</p>
                    <p class="mb-1"><strong>Type:</strong> {{ query.query_type or 'General' }}</p>
                    <p class="mb-0"><strong>Source:</strong> {{ query.source or 'Website' }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Recent history</h5>
                    <ul class="list-unstyled mb-0">
                        <li><strong>First response:</strong> {{ query.first_response_at.strftime('%Y-%m-%d %H:%M') if query.first_response_at else 'Not yet' }}</li>
                        <li><strong>Resolved:</strong> {{ query.resolved_at.strftime('%Y-%m-%d %H:%M') if query.resolved_at else 'Not yet' }}</li>
                        <li><strong>Last channel:</strong> {{ query.last_contact_channel or '—' }}</li>
                        {% if query.escalation_reason %}
                            <li><strong>Escalation reason:</strong> {{ query.escalation_reason }}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    Original message
                </div>
                <div class="card-body">
                    <pre class="mb-0" style="white-space: pre-wrap;">{{ query.message }}</pre>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Response timeline</span>
                    <span class="badge bg-light text-dark">{{ query.responses|length }} entries</span>
                </div>
                <div class="card-body">
                    {% if query.responses %}
                        <ul class="timeline list-unstyled mb-0">
                            {% for response in query.responses %}
                                <li class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>{{ response.subject }}</strong>
                                        <small class="text-muted">{{ response.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="text-muted mb-1">
                                        {{ response.staff.username if response.staff else 'System' }} • {{ response.channel|capitalize }}
                                        {% if response.status_after %} • Status: {{ response.status_after }}{% endif %}
                                    </div>
                                    <p class="mb-1" style="white-space: pre-wrap;">{{ response.body }}</p>
                                    {% if response.attachment_urls %}
                                        <div class="small">Attachments:
                                            {% for link in response.attachment_urls.split(',') %}
                                                <a href="{{ link }}" target="_blank">{{ link }}</a>{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">No responses logged yet.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">Customer history</div>
                <div class="card-body">
                    {% if related_queries %}
                        <ul class="list-group list-group-flush">
                            {% for rq in related_queries %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">{{ rq.query_type or 'General' }} • {{ rq.priority }}</div>
                                        <small class="text-muted">{{ rq.created_at.strftime('%Y-%m-%d') }} • Status: {{ rq.status }}</small>
                                    </div>
                                    <a href="{{ url_for('admin.query_detail', query_id=rq.id) }}" class="btn btn-sm btn-outline-secondary">View</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">No previous tickets for this customer.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header">Assign &amp; status</div>
                <div class="card-body">
                    <form method="post">
                        {{ update_form.hidden_tag() }}
                        <input type="hidden" name="action" value="update">
                        <div class="mb-3">
                            {{ update_form.assigned_staff_id.label(class="form-label") }}
                            {{ update_form.assigned_staff_id(class="form-select") }}
                        </div>
                        <div class="mb-3">
                            {{ update_form.status.label(class="form-label") }}
                            {{ update_form.status(class="form-select") }}
                        </div>
                        <div class="mb-3">
                            {{ update_form.priority.label(class="form-label") }}
                            {{ update_form.priority(class="form-select") }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save changes</button>
                    </form>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header">Send quick response</div>
                <div class="card-body">
                    <form method="post">
                        {{ response_form.hidden_tag() }}
                        <input type="hidden" name="action" value="respond">
                        <div class="mb-3">
                            {{ response_form.template_id.label(class="form-label") }}
                            {{ response_form.template_id(class="form-select", id=response_form.template_id.id) }}
                        </div>
                        <div class="mb-3">
                            {{ response_form.channel.label(class="form-label") }}
                            {{ response_form.channel(class="form-select") }}
                        </div>
                        <div class="mb-3">
                            {{ response_form.subject.label(class="form-label") }}
                            {{ response_form.subject(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ response_form.body.label(class="form-label") }}
                            {{ response_form.body(class="form-control", rows="4") }}
                        </div>
                        <div class="mb-3">
                            {{ response_form.attachment_urls.label(class="form-label") }}
                            {{ response_form.attachment_urls(class="form-control", placeholder="https://example.com/brochure.pdf") }}
                        </div>
                        <div class="form-check mb-2">
                            {{ response_form.send_email(class="form-check-input", id="send_email") }}
                            <label class="form-check-label" for="send_email">Notify customer via email</label>
                        </div>
                        <div class="form-check mb-3">
                            {{ response_form.log_internal_note(class="form-check-input", id="log_note") }}
                            <label class="form-check-label" for="log_note">Log as internal note</label>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Send response</button>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">Escalation</div>
                <div class="card-body">
                    <form method="post">
                        {{ escalation_form.hidden_tag() }}
                        <input type="hidden" name="action" value="escalate">
                        <div class="mb-3">
                            {{ escalation_form.escalate_to.label(class="form-label") }}
                            {{ escalation_form.escalate_to(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ escalation_form.priority.label(class="form-label") }}
                            {{ escalation_form.priority(class="form-select") }}
                        </div>
                        <div class="mb-3">
                            {{ escalation_form.reason.label(class="form-label") }}
                            {{ escalation_form.reason(class="form-control", rows="3") }}
                        </div>
                        <button type="submit" class="btn btn-outline-danger w-100">Escalate</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const templates = {{ templates_payload|tojson|safe }};
    const templateSelect = document.getElementById('{{ response_form.template_id.id }}');
    const subjectInput = document.getElementById('{{ response_form.subject.id }}');
    const bodyInput = document.getElementById('{{ response_form.body.id }}');

    if (templateSelect) {
        templateSelect.addEventListener('change', function () {
            const selected = templates.find(function (t) {
                return t.id === Number(templateSelect.value);
            });
            if (selected) {
                if (!subjectInput.value || subjectInput.value.startsWith('Re:')) {
                    subjectInput.value = selected.subject;
                }
                bodyInput.value = selected.body;
            }
        });
    }
});
</script>
{% endblock %}

